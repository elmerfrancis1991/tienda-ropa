rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {
    
    // --- HELPER FUNCTIONS ---

    // 1. Is Authenticated
    function isAuth() {
      return request.auth != null;
    }

    // 2. Get User Data (fetching from Firestore)
    function getUserData() {
      return get(/databases/$(database)/documents/users/$(request.auth.uid)).data;
    }

    // 2b. Check if User Document exists
    function hasUserData() {
      return exists(/databases/$(database)/documents/users/$(request.auth.uid));
    }

    // 3. Get User's Tenant ID
    function getTenantId() {
      return hasUserData() ? getUserData().tenantId : null;
    }

    // 4. Verify User is Admin
    function isAdmin() {
      return hasUserData() && getUserData().role == 'admin';
    }

    // 5. Belongs to Tenant
    function belongsToTenant(resourceData) {
      let tenantId = getTenantId();
      return isAuth() && tenantId != null && resourceData.tenantId == tenantId;
    }

    // 6. Creating in Tenant
    function creatingInTenant() {
      return isAuth() && request.resource.data.tenantId == getTenantId();
    }

    // 7. Is Owner of Document (User ID matches)
    function isOwner(userId) {
      return isAuth() && request.auth.uid == userId;
    }

    // --- RULES ---

    // USERS COLLECTION
    // - Read: User can see themselves OR Admin from SAME tenant can see them.
    // - Write: Admin from SAME tenant can manage users. User can update limited fields.
    match /users/{userId} {
      // Allow user to read their own profile (needed for getTenantId recursion potentially, but firestore handles self-access well usually)
      allow read: if isOwner(userId) || (isAdmin() && belongsToTenant(resource.data));
      
      // Create: Allow creating if it's the first user (bootstrap) or by Admin of same tenant (conceptually tricky during signup)
      // For simplicity/MVP: Authenticated users can create their own profile with a tenantId. 
      // Ideally this is done via Cloud Functions to prevent spoofing tenantId, but for client-side app:
      allow create: if isAuth() && (
        request.auth.uid == userId || 
        (isAdmin() && request.resource.data.tenantId == getTenantId())
      );
      
      allow update: if (isAdmin() && belongsToTenant(resource.data)) || isOwner(userId);
      allow delete: if isAdmin() && belongsToTenant(resource.data);
    }

    // PRODUCTOS
    // - Read: Auth users in same tenant.
    // - Write: Admin in same tenant.
    match /productos/{productoId} {
      allow read: if isAuth() && belongsToTenant(resource.data);
      allow create: if (isAdmin() && creatingInTenant()) || (isAuth() && creatingInTenant()); // Allow auth users to create products? No, typically Admin. 
      // Update: Admin can do anything. Vendedor needs to update stock.
      // Ideally, stock updates happens via Cloud Function. Client side: allow update if isAuth() and belongsToTenant().
      allow update: if (isAdmin() && belongsToTenant(resource.data)) || (isAuth() && belongsToTenant(resource.data)); 
      allow delete: if isAdmin() && belongsToTenant(resource.data);
    }

    // VENTAS
    // - Read: Admin can see all tenant sales.
    // - Create: Any Auth user in tenant (Cajero).
    // - Update/Delete: Admin only.
    match /ventas/{ventaId} {
      allow read: if (isAdmin() && belongsToTenant(resource.data)) || (isAuth() && belongsToTenant(resource.data)); // Allow viewing sales history?
      allow create: if isAuth() && creatingInTenant();
      allow update, delete: if isAdmin() && belongsToTenant(resource.data);
    }

    // CIERRES DE CAJA
    match /cierres_caja/{cierreId} {
      allow read: if isAuth() && belongsToTenant(resource.data);
      allow create: if isAuth() && creatingInTenant();
      allow update: if isAuth() && belongsToTenant(resource.data);
      allow delete: if isAdmin() && belongsToTenant(resource.data);
    }

    // CONFIGURACION
    match /config/{configId} {
      allow read: if isAuth(); // Allow all for now, or match tenant if config has tenantId
      allow write: if isAdmin();
    }
  }
}
